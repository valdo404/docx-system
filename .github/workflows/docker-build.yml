name: Build, Test & Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - 'installers/**'
      - 'publish.sh'
      - '.github/workflows/docker-build.yml'
      - '.github/scripts/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'Dockerfile'
      - 'docker-compose*.yml'
      - 'installers/**'
      - 'publish.sh'
      - '.github/workflows/docker-build.yml'
      - '.github/scripts/**'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: 'false'
        type: boolean

env:
  DOCKERHUB_IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/docx-mcp
  DOTNET_VERSION: '10.0.x'

jobs:
  # =============================================================================
  # Build Rust Storage Server (all architectures first)
  # =============================================================================
  build-storage:
    name: Build Storage Server (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            artifact-name: linux-x64
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
            artifact-name: linux-arm64
          # macOS
          - target: x86_64-apple-darwin
            runner: macos-15-intel  # Intel runner
            artifact-name: macos-x64
          - target: aarch64-apple-darwin
            runner: macos-latest  # Apple Silicon runner
            artifact-name: macos-arm64
          # Windows
          - target: x86_64-pc-windows-msvc
            runner: windows-latest
            artifact-name: windows-x64
          - target: aarch64-pc-windows-msvc
            runner: windows-latest
            artifact-name: windows-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install protoc (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install protoc (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install protoc -y
          echo "C:\ProgramData\chocolatey\lib\protoc\tools\bin" >> $env:GITHUB_PATH

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM64 on x64)
        if: matrix.target == 'aarch64-unknown-linux-gnu' && matrix.runner == 'ubuntu-latest'
        run: sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build storage server
        run: cargo build --release --target ${{ matrix.target }} -p docx-storage-local

      - name: Prepare artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist/${{ matrix.artifact-name }}
          cp target/${{ matrix.target }}/release/docx-storage-local dist/${{ matrix.artifact-name }}/
          chmod +x dist/${{ matrix.artifact-name }}/docx-storage-local

      - name: Prepare artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist/${{ matrix.artifact-name }}
          Copy-Item target/${{ matrix.target }}/release/docx-storage-local.exe dist/${{ matrix.artifact-name }}/

      - name: Upload storage server artifact
        uses: actions/upload-artifact@v4
        with:
          name: storage-${{ matrix.artifact-name }}
          path: dist/${{ matrix.artifact-name }}

  # =============================================================================
  # Tests
  # =============================================================================
  test:
    name: Run Tests
    needs: build-storage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download storage server
        uses: actions/download-artifact@v4
        with:
          name: storage-linux-x64
          path: dist/linux-x64

      - name: Make storage server executable
        run: chmod +x dist/linux-x64/docx-storage-local

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: preview

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        run: dotnet test --no-build --configuration Release --verbosity normal

  # =============================================================================
  # Linux Docker Build (Native parallel builds + manifest merge)
  # =============================================================================
  docker-linux:
    name: Docker Linux (${{ matrix.arch }})
    needs: test
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            platform: linux/amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            platform: linux/arm64

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_IMAGE }}
          labels: |
            org.opencontainers.image.title=docx-mcp
            org.opencontainers.image.description=MCP server for Microsoft Word DOCX manipulation
            org.opencontainers.image.vendor=${{ vars.DOCKERHUB_USERNAME }}
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}
          # Suffix tags with arch for per-arch images
          flavor: |
            suffix=-${{ matrix.arch }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: ${{ github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')) }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=${{ matrix.arch }}

  # =============================================================================
  # Merge multi-arch manifests
  # =============================================================================
  docker-manifest:
    name: Docker Manifest
    needs: docker-linux
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}

      - name: Create and push manifests
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          # For each tag, create a manifest combining amd64 and arm64
          # Use imagetools which handles manifest lists properly
          echo "$TAGS" | while IFS= read -r tag; do
            [ -z "$tag" ] && continue
            echo "Creating manifest for $tag"
            docker buildx imagetools create -t "$tag" \
              "${tag}-amd64" \
              "${tag}-arm64"
          done

      - name: Update Docker Hub README
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.DOCKERHUB_IMAGE }}
          readme-filepath: ./DOCKER_README.md
          short-description: "MCP server for Microsoft Word DOCX manipulation - structured queries, undo/redo, Track Changes"

  # =============================================================================
  # Windows Installer (Inno Setup)
  # =============================================================================
  installer-windows:
    name: Windows Installer ${{ matrix.arch }}
    needs: [test, build-storage]
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
      - uses: actions/checkout@v4

      - name: Download storage server
        uses: actions/download-artifact@v4
        with:
          name: storage-windows-${{ matrix.arch }}
          path: dist/windows-${{ matrix.arch }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: preview

      - name: Build MCP Server (NativeAOT)
        run: |
          dotnet publish src/DocxMcp/DocxMcp.csproj `
            --configuration Release `
            --runtime win-${{ matrix.arch }} `
            --self-contained true `
            -p:PublishAot=true `
            -p:OptimizationPreference=Size `
            --output dist/windows-${{ matrix.arch }}

      - name: Build CLI (NativeAOT)
        run: |
          dotnet publish src/DocxMcp.Cli/DocxMcp.Cli.csproj `
            --configuration Release `
            --runtime win-${{ matrix.arch }} `
            --self-contained true `
            -p:PublishAot=true `
            -p:OptimizationPreference=Size `
            --output dist/windows-${{ matrix.arch }}

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match '^refs/tags/v(.+)$') {
            $version = $matches[1]
          } else {
            $version = "0.0.0-dev"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Prepare Inno Setup script
        shell: pwsh
        run: |
          $issContent = Get-Content "installers/windows/docx-mcp.iss" -Raw

          # Remove SetupIconFile line if icon doesn't exist
          if (-not (Test-Path "installers/windows/docx-mcp.ico")) {
            $issContent = $issContent -replace 'SetupIconFile=docx-mcp.ico\r?\n', ''
          }

          # Handle LICENSE file - create if missing
          if (-not (Test-Path "LICENSE")) {
            "MIT License`n`nCopyright (c) 2024 DocX MCP Team`n`nPermission is hereby granted..." | Out-File -FilePath "LICENSE" -Encoding utf8
          }

          Set-Content "installers/windows/docx-mcp-build.iss" $issContent

      - name: Build installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
        with:
          path: installers/windows/docx-mcp-build.iss
          options: /DMyAppVersion=${{ steps.version.outputs.VERSION }} /DMyAppArch=${{ matrix.arch }}

      - name: Sign installer (if certificate available)
        shell: pwsh
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          if ([string]::IsNullOrEmpty($env:WINDOWS_CERTIFICATE)) {
            Write-Host "No Windows certificate configured, skipping signing"
            exit 0
          }

          $certBytes = [Convert]::FromBase64String($env:WINDOWS_CERTIFICATE)
          $certPath = "certificate.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          $installer = Get-ChildItem "dist/installers/*.exe" | Select-Object -First 1
          & signtool sign /f $certPath /p $env:WINDOWS_CERTIFICATE_PASSWORD /tr http://timestamp.digicert.com /td sha256 /fd sha256 $installer.FullName

          Remove-Item $certPath

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}-installer
          path: dist/installers/*.exe

  # =============================================================================
  # macOS Installer (Universal DMG)
  # =============================================================================
  installer-macos:
    name: macOS Universal Installer
    needs: [test, build-storage]
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download storage server (x64)
        uses: actions/download-artifact@v4
        with:
          name: storage-macos-x64
          path: dist/macos-x64

      - name: Download storage server (arm64)
        uses: actions/download-artifact@v4
        with:
          name: storage-macos-arm64
          path: dist/macos-arm64

      - name: Make storage servers executable
        run: |
          chmod +x dist/macos-x64/docx-storage-local
          chmod +x dist/macos-arm64/docx-storage-local

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          dotnet-quality: preview

      - name: Build MCP Server (x64)
        run: |
          dotnet publish src/DocxMcp/DocxMcp.csproj \
            --configuration Release \
            --runtime osx-x64 \
            --self-contained true \
            -p:PublishAot=true \
            -p:OptimizationPreference=Size \
            --output dist/macos-x64

      - name: Build MCP Server (arm64)
        run: |
          dotnet publish src/DocxMcp/DocxMcp.csproj \
            --configuration Release \
            --runtime osx-arm64 \
            --self-contained true \
            -p:PublishAot=true \
            -p:OptimizationPreference=Size \
            --output dist/macos-arm64

      - name: Build CLI (x64)
        run: |
          dotnet publish src/DocxMcp.Cli/DocxMcp.Cli.csproj \
            --configuration Release \
            --runtime osx-x64 \
            --self-contained true \
            -p:PublishAot=true \
            -p:OptimizationPreference=Size \
            --output dist/macos-x64

      - name: Build CLI (arm64)
        run: |
          dotnet publish src/DocxMcp.Cli/DocxMcp.Cli.csproj \
            --configuration Release \
            --runtime osx-arm64 \
            --self-contained true \
            -p:PublishAot=true \
            -p:OptimizationPreference=Size \
            --output dist/macos-arm64

      - name: Create Universal Binaries
        run: |
          mkdir -p dist/macos-universal

          # Create universal binary for docx-mcp
          lipo -create \
            dist/macos-x64/docx-mcp \
            dist/macos-arm64/docx-mcp \
            -output dist/macos-universal/docx-mcp

          # Create universal binary for docx-cli
          lipo -create \
            dist/macos-x64/docx-cli \
            dist/macos-arm64/docx-cli \
            -output dist/macos-universal/docx-cli

          # Create universal binary for docx-storage-local
          lipo -create \
            dist/macos-x64/docx-storage-local \
            dist/macos-arm64/docx-storage-local \
            -output dist/macos-universal/docx-storage-local

          chmod +x dist/macos-universal/docx-mcp
          chmod +x dist/macos-universal/docx-cli
          chmod +x dist/macos-universal/docx-storage-local

          # Verify universal binaries
          echo "docx-mcp architectures:"
          lipo -info dist/macos-universal/docx-mcp
          echo "docx-cli architectures:"
          lipo -info dist/macos-universal/docx-cli
          echo "docx-storage-local architectures:"
          lipo -info dist/macos-universal/docx-storage-local

      - name: Extract version
        id: version
        run: |
          if [[ "$GITHUB_REF" =~ ^refs/tags/v(.+)$ ]]; then
            echo "VERSION=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Import Apple certificates
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_INSTALLER_CERTIFICATE: ${{ secrets.APPLE_INSTALLER_CERTIFICATE }}
          APPLE_INSTALLER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_PASSWORD }}
        run: |
          if [[ -z "$APPLE_CERTIFICATE" ]]; then
            echo "No Apple certificate configured, skipping signing setup"
            exit 0
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          rm $RUNNER_TEMP/certificate.p12

          if [[ -n "$APPLE_INSTALLER_CERTIFICATE" ]]; then
            echo "$APPLE_INSTALLER_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/installer-cert.p12
            security import $RUNNER_TEMP/installer-cert.p12 -P "$APPLE_INSTALLER_CERTIFICATE_PASSWORD" \
              -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
            rm $RUNNER_TEMP/installer-cert.p12
          fi

          security list-keychain -d user -s $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          APP_IDENTITY=$(security find-identity -v -p codesigning $KEYCHAIN_PATH | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          INSTALLER_IDENTITY=$(security find-identity -v -p codesigning $KEYCHAIN_PATH | grep "Developer ID Installer" | head -1 | sed 's/.*"\(.*\)".*/\1/')

          echo "APP_SIGNING_IDENTITY=$APP_IDENTITY" >> $GITHUB_ENV
          echo "INSTALLER_SIGNING_IDENTITY=$INSTALLER_IDENTITY" >> $GITHUB_ENV
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Build PKG installer
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          ARCH: universal
          SIGNING_IDENTITY: ${{ env.APP_SIGNING_IDENTITY }}
          INSTALLER_SIGNING_IDENTITY: ${{ env.INSTALLER_SIGNING_IDENTITY }}
        run: |
          chmod +x installers/macos/build-pkg.sh
          ./installers/macos/build-pkg.sh

      - name: Build DMG installer
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          ARCH: universal
          SIGNING_IDENTITY: ${{ env.APP_SIGNING_IDENTITY }}
        run: |
          chmod +x installers/macos/build-dmg.sh
          ./installers/macos/build-dmg.sh

      - name: Cleanup keychain
        if: ${{ always() && env.KEYCHAIN_PATH != '' }}
        run: |
          security delete-keychain $KEYCHAIN_PATH || true

      - name: Upload DMG installer
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal-dmg
          path: dist/installers/*.dmg

  # =============================================================================
  # Create GitHub Release
  # =============================================================================
  release:
    name: Create Release
    needs: [docker-manifest, installer-windows, installer-macos]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Download Windows installers
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: windows-*-installer

      - name: Download macOS installer
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: macos-*-dmg

      - name: Extract version
        id: version
        run: .github/scripts/extract-version.sh

      - name: Prepare release assets
        run: .github/scripts/prepare-release-assets.sh

      - name: Generate release notes
        run: .github/scripts/generate-release-notes.sh "${{ steps.version.outputs.VERSION }}" "${{ env.DOCKERHUB_IMAGE }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: DocX MCP Server ${{ steps.version.outputs.VERSION }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ steps.version.outputs.PRERELEASE == 'true' }}
          files: release-assets/*
          make_latest: ${{ steps.version.outputs.PRERELEASE != 'true' }}
