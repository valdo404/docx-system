---
import type { Lang } from '../i18n/ui';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const dashboardPath = lang === 'fr' ? '/tableau-de-bord' : '/en/dashboard';
const loginPath = lang === 'fr' ? '/connexion' : '/en/login';
---

<auth-aware-ui
  data-dashboard={dashboardPath}
  data-login={loginPath}
  data-lang={lang}
>
  <slot />
</auth-aware-ui>

<script>
  import { authClient } from '../lib/auth-client';

  class AuthAwareUI extends HTMLElement {
    async connectedCallback() {
      const dashboard = this.dataset.dashboard!;
      const login = this.dataset.login!;
      const lang = this.dataset.lang as 'fr' | 'en';

      let user = null;

      try {
        const session = await authClient.getSession();
        user = session?.data?.user;
      } catch (e) {
        console.debug('Auth check failed:', e);
      }

      // Update avatar slot
      const avatarSlot = this.querySelector('[data-auth-avatar]');
      if (avatarSlot) {
        if (user) {
          const initials = this.getInitials(user.name || user.email || '?');
          avatarSlot.innerHTML = `
            <a href="${dashboard}" class="user-avatar" title="${user.name || user.email}">
              ${initials}
            </a>
          `;
        } else {
          // Show login link when not authenticated
          const loginText = lang === 'fr' ? 'Connexion' : 'Log in';
          avatarSlot.innerHTML = `
            <a href="${login}" class="nav-login-link">${loginText}</a>
          `;
        }
      }

      // Update CTA slots - only change if authenticated
      if (user) {
        this.querySelectorAll('[data-auth-cta]').forEach(cta => {
          const link = cta.querySelector('a');
          if (link) {
            link.href = dashboard;
            link.textContent = lang === 'fr' ? 'Accéder à la console' : 'Access console';
          }
        });
      }
    }

    getInitials(name: string): string {
      return name.split(' ').map(w => w[0]).slice(0, 2).join('').toUpperCase() || '?';
    }
  }

  customElements.define('auth-aware-ui', AuthAwareUI);
</script>

<style is:global>
  .user-avatar {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--brand-primary);
    color: white;
    font-size: var(--font-size-200);
    font-weight: var(--font-weight-semibold);
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .user-avatar:hover {
    opacity: 0.9;
    text-decoration: none;
  }

  .nav-login-link {
    color: var(--text-secondary);
    font-size: var(--font-size-300);
    transition: color 0.2s;
  }

  .nav-login-link:hover {
    color: var(--text-primary);
    text-decoration: none;
  }
</style>
