/**
 * Build a fluent-tree-view from the DOM generated by docx-preview.js.
 * Inspects the rendered HTML to extract headings, paragraphs, and tables.
 */
export function buildTreeFromPreview(previewContainer) {
    const treeView = document.createElement('fluent-tree-view');

    // docx-preview wraps content in a div with class "docx-wrapper" or the rendered section
    const wrapper = previewContainer.querySelector('.docx-wrapper')
        || previewContainer.querySelector('section.docx')
        || previewContainer;

    if (!wrapper || !wrapper.children) return treeView;

    let pIdx = 0, tIdx = 0;

    for (const child of wrapper.children) {
        // Skip style elements and non-content
        if (child.tagName === 'STYLE' || child.tagName === 'LINK') continue;

        const item = document.createElement('fluent-tree-item');

        if (child.tagName?.match(/^H[1-6]$/i)) {
            const level = child.tagName[1];
            const text = truncate(child.textContent, 40);
            item.textContent = `H${level}: ${text}`;
            child.id = child.id || `el-h-${pIdx}`;
            item.dataset.target = child.id;
            pIdx++;
        }
        else if (child.tagName === 'P' || child.classList?.contains('docx')) {
            const text = truncate(child.textContent, 40);
            if (!text.trim()) { pIdx++; continue; }
            item.textContent = `P[${pIdx}]: ${text}`;
            child.id = child.id || `el-p-${pIdx}`;
            item.dataset.target = child.id;
            pIdx++;
        }
        else if (child.tagName === 'TABLE') {
            const rows = child.querySelectorAll('tr').length;
            item.textContent = `Table[${tIdx}] (${rows} rows)`;
            child.id = child.id || `el-t-${tIdx}`;
            item.dataset.target = child.id;
            tIdx++;
        }
        else {
            pIdx++;
            continue;
        }

        item.addEventListener('click', () => {
            const target = previewContainer.querySelector(`#${item.dataset.target}`);
            target?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Brief highlight
            target?.classList.add('highlight-flash');
            setTimeout(() => target?.classList.remove('highlight-flash'), 1500);
        });

        treeView.appendChild(item);
    }

    if (treeView.children.length === 0) {
        const empty = document.createElement('fluent-tree-item');
        empty.textContent = '(empty document)';
        empty.setAttribute('disabled', '');
        treeView.appendChild(empty);
    }

    return treeView;
}

function truncate(text, maxLen) {
    const clean = (text || '').replace(/\s+/g, ' ').trim();
    return clean.length > maxLen ? clean.substring(0, maxLen) + '...' : clean;
}
